= GLPI on Kubernetes
A.C. <a dot costa at trikorasolutions dot com>
:Date:      {docdate}
:Revision:  1
:table-caption: Table
:toc: left
:toc-title: Table of Contents
:icons: font
:description: GLPI on Kubernetes guide.
:source-highlighter: rouge


== GLPI k8s deployment guide

Reference: 
  * https://github.com/fametec/glpi
  * https://glpi-install.readthedocs.io/en/latest/install/index.html#installation
  * https://github.com/driket/docker-glpi

Password

== Deploy

Reference:
* https://aws.amazon.com/blogs/containers/introducing-security-groups-for-pods/

Create glpi namespace.

[source,bash]
----
$ kubectl delete -f 00-glpi-namespace.yaml

$ kubectl create -f 00-glpi-namespace.yaml
----

== mariadb

Persistence storage and database.


[source,bash]
----
$ kubectl delete -f mariadb/25-mariadb-pvc.yaml
$ kubectl delete -f mariadb/24-mariadb-pv.yaml

$ kubectl create -f mariadb/24-mariadb-pv.yaml
$ kubectl create -f mariadb/25-mariadb-pvc.yaml
----

[source,bash]
----
$ kubectl delete -f mariadb/40-mariadb-service.yaml
$ kubectl delete -f mariadb/30-mariadb-statefulset.yaml
$ kubectl delete -f mariadb/10-mariadb-configmap.yaml
$ kubectl delete -f mariadb/05-mariadb-secret.yaml

$ kubectl create -f mariadb/05-mariadb-secret.yaml
$ kubectl create -f mariadb/10-mariadb-configmap.yaml
$ kubectl create -f mariadb/30-mariadb-statefulset.yaml
$ kubectl create -f mariadb/40-mariadb-service.yaml
----

> NOTE: TBD: UID and GID for pv is 27:27.

=== Info from deployment

Get information from the service.

[source,bash]
----
$ kubectl -n glpi get svc mariadb
NAME       TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
mariadb   NodePort   10.99.55.151   <none>        5432:32737/TCP   33m
----

=== Connecting to mariadb

To connect from inside the cluster use the following host `service.namespace.svc.cluster.local`.

`mariadb.glpi.svc.cluster.local`

== phpMyAdmin

[source,bash]
----
$ kubectl delete -f phpmyadmin/40-phpmyadmin-ingress.yaml
$ kubectl delete -f phpmyadmin/30-phpmyadmin-service.yaml
$ kubectl delete -f phpmyadmin/20-phpmyadmin-deployment.yaml
$ kubectl delete -f phpmyadmin/10-phpmyadmin-configmap.yaml
$ kubectl delete -f phpmyadmin/05-phpmyadmin-secret.yaml

$ kubectl create -f phpmyadmin/05-phpmyadmin-secret.yaml
$ kubectl create -f phpmyadmin/10-phpmyadmin-configmap.yaml
$ kubectl create -f phpmyadmin/20-phpmyadmin-deployment.yaml
$ kubectl create -f phpmyadmin/30-phpmyadmin-service.yaml
$ kubectl create -f phpmyadmin/40-phpmyadmin-ingress.yaml
----

== GLPI

Persistence storage.

[source,bash]
----
$ kubectl delete -f glpi/16-glpi-pvc.yaml
$ kubectl delete -f glpi/15-glpi-pv.yaml

$ kubectl create -f glpi/15-glpi-pv.yaml
$ kubectl create -f glpi/16-glpi-pvc.yaml
----

On the PV folder, create GLPI folders...

[source,bash]
----
$ mkdir _cron
$ mkdir _dumps
$ mkdir _graphs
$ mkdir _lock
$ mkdir _pictures
$ mkdir _plugins
$ mkdir _rss
$ mkdir _sessions
$ mkdir _tmp
$ mkdir _uploads
$ mkdir _cache
----

... and assign the correct `user:group`.

[source,bash]
----
$ sudo chown 48:48 -R *
----

Installation.

[source,bash]
----
$ kubectl delete -f glpi/40-glpi-ingress.yaml
$ kubectl delete -f glpi/30-glpi-service.yaml
$ kubectl delete -f glpi/20-glpi-deployment.yaml
$ kubectl delete -f glpi/10-glpi-configmap.yaml
$ kubectl delete -f glpi/05-glpi-secret.yaml
$ kubectl delete -f glpi/01-glpi-serviceaccount.yaml

$ kubectl create -f glpi/01-glpi-serviceaccount.yaml
$ kubectl create -f glpi/05-glpi-secret.yaml
$ kubectl create -f glpi/10-glpi-configmap.yaml
$ kubectl create -f glpi/20-glpi-deployment.yaml
$ kubectl create -f glpi/30-glpi-service.yaml
$ kubectl create -f glpi/40-glpi-ingress.yaml
----

=== Configure GLPI

Identify the GLPI pod.

[source,bash]
----
$ kubectl -n glpi get pods
NAME                                     READY   STATUS    RESTARTS   AGE
glpi-75f944445c-ncjss                    1/1     Running   0          2m45s
glpi-mariadb-0                           1/1     Running   0          179m
phpmyadmin-deployment-74fc9dd457-dljld   1/1     Running   0          2d11h
----

Set the GLPI pod variable.

[source,bash]
----
$ GLPI_POD=glpi-75f944445c-ncjss
----

[source,bash]
----
$ kubectl -n glpi exec -it ${GLPI_POD} -- php bin/console db:install
+---------------+--------------------------------+
| Database host | mariadb.glpi.svc.cluster.local |
| Database name | glpi                           |
| Database user | glpi                           |
+---------------+--------------------------------+
Do you want to continue ? [Yes/no]Yes
Database already contains "glpi_*" tables. Use --force option to override existing database.
command terminated with exit code 6
----

== Podman

To test in podman.

[source,bash]
----
$ podman pod rm glpi_db_pod ; podman pod create -p 7806:3306 --name glpi_db_pod
$ podman run --name glpi_db --pod glpi_db_pod -d \
  -e MYSQL_ROOT_PASSWORD=glpi -e MYSQL_DATABASE=glpi -e MYSQL_USER=glpi -e MYSQL_PASSWORD=glpi \
  mariadb:latest
----

== Backup & Restore



== Upgrade

WARNING: TODO


:include::troubleshooting.adoc[leveloffset=+2]

