---
- name: "Build and Tag images"
  hosts: "{{ target_host | default('localhost') }}"
  gather_facts: true

  pre_tasks:
    - name: "Include project vars"
      ansible.builtin.include_vars: "{{ file_to_include }}"
      loop:
        - vars/main.yaml
      loop_control:
        loop_var: file_to_include

    - name: "Get version"
      ansible.builtin.shell: |
        jq -r '(.major | tostring) + "." + (.minor | tostring) + "." + (.patch | tostring) + if .snapshot then "-SNAPSHOT" else "" end' ../../../version.json
      register: current_version

    - name: "Print version"
      ansible.builtin.debug:
        var: current_version

  tasks:
    - name: "Build the CORE image"
      ansible.builtin.shell: |
        buildah bud -t {{ image_prefix }}_core:{{ current_version.stdout }} -f src/main/core/Dockerfile
      args:
        chdir: "{{ chdir_ref }}"

    - name: "Build the init container image"
      ansible.builtin.shell: |
        buildah bud -t {{ image_prefix }}_init:{{ current_version.stdout }} -f src/main/init/Dockerfile
      args:
        chdir: "{{ chdir_ref }}"

    - name: "Build the web application image"
      ansible.builtin.shell: |
        buildah bud -t {{ image_prefix }}_web:{{ current_version.stdout }} -f src/main/web/Dockerfile
      args:
        chdir: "{{ chdir_ref }}"

    - name: "Build the cron image"
      ansible.builtin.shell: |
        buildah bud -t {{ image_prefix }}_cron:{{ current_version.stdout }} -f src/main/cron/Dockerfile
      args:
        chdir: "{{ chdir_ref }}"
...
